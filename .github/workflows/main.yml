name: Build Unsigned IPA (ChatGPT-iOS)

on:
  workflow_dispatch:
  push:
    branches: ["master"]
  pull_request:

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode version
        run: xcodebuild -version

      # This repo contains ChatGPT.xcodeproj (not a workspace).  [oai_citation:1‡GitHub](https://github.com/capnslipp/ChatGPT-iOS)
      - name: Archive (Release, iphoneos, NO code signing)
        run: |
          set -euxo pipefail
          mkdir -p build

          xcodebuild \
            -project "ChatGPT.xcodeproj" \
            -scheme "ChatGPT" \
            -configuration "Release" \
            -sdk "iphoneos" \
            -destination "generic/platform=iOS" \
            -archivePath "$PWD/build/ChatGPT.xcarchive" \
            clean archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM=""

      - name: Make unsigned IPA (zip Payload/)
        run: |
          set -euxo pipefail

          # The product name in this repo is intended to be ChatGPT.app (project is ChatGPT).  [oai_citation:2‡GitHub](https://github.com/capnslipp/ChatGPT-iOS)
          APP_PATH="$PWD/build/ChatGPT.xcarchive/Products/Applications/ChatGPT.app"

          # If the .app name differs for any reason, auto-detect it instead of dying.
          if [ ! -d "$APP_PATH" ]; then
            echo "ChatGPT.app not found. Auto-detecting .app in archive..."
            APP_PATH="$(find "$PWD/build/ChatGPT.xcarchive/Products/Applications" -maxdepth 1 -type d -name '*.app' | head -n 1)"
          fi

          if [ -z "${APP_PATH:-}" ] || [ ! -d "$APP_PATH" ]; then
            echo "❌ No .app found in archive."
            find "$PWD/build/ChatGPT.xcarchive" -maxdepth 5 -type d -name '*.app' || true
            exit 1
          fi

          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          rm -f ChatGPT-unsigned.ipa
          /usr/bin/zip -r "ChatGPT-unsigned.ipa" Payload

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChatGPT-iOS-unsigned-ipa
          path: ChatGPT-unsigned.ipa
          if-no-files-found: error
